<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Zoom Workplace Chatbot Demo</title>

    <!-- ‚úÖ Public script (global zoomSdk) -->
    <script src="https://appssdk.zoom.us/sdk.min.js" defer></script>
    
    <!-- External CSS file -->
    <link rel="stylesheet" href="/css/webview.css" />
  </head>

  <body>
    <div id="not-in-zoom-message" class="not-in-zoom" style="display: none">
      <h2>‚ö†Ô∏è Zoom Client Required</h2>
      <p>
        This page is designed to run inside the Zoom desktop or mobile client.
      </p>
      <p>
        Please open this URL from within a Zoom chat or meeting to access the
        full functionality.
      </p>
    </div>

    <div id="main-content">
      <h1>üöÄ Zoom Workplace Chatbot Demo</h1>

      <div class="demo-container">
        <div class="form-group">
          <label for="messageInput">Custom Message</label>
          <textarea
            id="messageInput"
            placeholder="Type your message here to send to the chat..."
          ></textarea>
          <div class="hint">
            Enter any text you want to send as a message to the current chat
          </div>
        </div>

        <div class="button-group">
          <button id="sendCustomBtn" class="btn-primary">
            Send Custom Message
          </button>
          <button id="sendContextBtn" class="btn-secondary">
            Send Chat Context
          </button>
        </div>

        <div class="hint" style="text-align: center; margin-top: 16px">
          This demo shows how Zoom Apps can interact with chat conversations
        </div>
      </div>

      <div class="context-section">
        <div class="context-title">üìä Context Information</div>
        <div class="context-item">
          <h4>Running Context</h4>
          <div id="runningContext" class="context-content">Not available</div>
        </div>
        <div class="context-item">
          <h4>Chat Context</h4>
          <div id="chatContext" class="context-content">Not available</div>
        </div>
      </div>

      <div id="status"></div>
    </div>

    <script>
      /* globals zoomSdk */

      let isInitialized = false;
      let chatContext = null;
      let runningContext = null;

      // Helper to show status messages
      function showStatus(message, type = "info") {
        const statusDiv = document.getElementById("status");
        statusDiv.innerHTML = `<div class="status ${type}">${message}</div>`;
        setTimeout(() => (statusDiv.innerHTML = ""), 3000);
      }

      // Helper to update context displays
      function updateContextDisplays() {
        const runningContextEl = document.getElementById("runningContext");
        const chatContextEl = document.getElementById("chatContext");

        if (runningContext) {
          runningContextEl.textContent = JSON.stringify(
            runningContext,
            null,
            2
          );
        }

        if (chatContext) {
          chatContextEl.textContent = JSON.stringify(chatContext, null, 2);
        }
      }

      // Check if running in Zoom client
      function checkZoomEnvironment() {
        if (typeof window.zoomSdk === "undefined") {
          document.getElementById("not-in-zoom-message").style.display = "block";
          document.getElementById("main-content").style.display = "none";
          return false;
        }
        return true;
      }

      // Helper to get signature from your backend
      async function generateSignature(messageString) {
        const res = await fetch("/api/sign", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ message: messageString }),
        });
        if (!res.ok) throw new Error("Signature request failed: " + res.status);
        return res.json();
      }

      // Send custom message function
      async function sendCustomMessage() {
        const messageInput = document.getElementById("messageInput");
        const message = messageInput.value.trim();

        if (!message) {
          showStatus("Please enter a message first", "error");
          return;
        }

        if (!isInitialized) {
          showStatus("Zoom SDK not initialized yet", "error");
          return;
        }

        try {
          showStatus("Sending message...", "info");

          await zoomSdk.sendMessageToChat({
            message: message,
          });

          showStatus("‚úÖ Message sent successfully!", "success");
          messageInput.value = ""; // Clear the input
          window.close();
        } catch (error) {
          console.error("Send message error:", error);
          showStatus("‚ùå Failed to send message", "error");
        }
      }

      // Send chat context function
      async function sendChatContext() {
        if (!isInitialized) {
          showStatus("Zoom SDK not initialized yet", "error");
          return;
        }

        if (!chatContext) {
          showStatus("No chat context available", "error");
          return;
        }

        try {
          showStatus("Sending chat context...", "info");

          const contextMessage = `Chat Context Info:
          üìß Chat Type: ${chatContext.chatType || "Unknown"}
          üë• Participants: ${chatContext.participants?.length || 0}
          üí¨ Content: ${chatContext.content || "No content"}`;

          await zoomSdk.sendMessageToChat({
            message: contextMessage,
          });

          showStatus("‚úÖ Chat context sent successfully!", "success");
          window.close();
        } catch (error) {
          console.error("Send context error:", error);
          showStatus("‚ùå Failed to send chat context", "error");
        }
      }

      

      // Initialize the Zoom SDK
      async function init() {
        if (!checkZoomEnvironment()) {
          return;
        }

        try {
          showStatus("üîÑ Initializing Zoom SDK...", "info");

          const capabilities = [
            "getRunningContext",
            "getChatContext",
            "sendMessageToChat",
          ];

          const appInfo = await zoomSdk.config({
            version: "0.16.26",
            capabilities,
          });

          // Get running context
          runningContext = await zoomSdk.getRunningContext();

          // Get chat context if in chat
          if (appInfo.runningContext === "inChat") {
            chatContext = await zoomSdk.getChatContext();
            isInitialized = true;
            showStatus("‚úÖ Ready! You can now send messages.", "success");
          } else {
            showStatus(
              "‚ö†Ô∏è This app works best when opened from a chat",
              "error"
            );
          }

          // Update context displays
          updateContextDisplays();
        } catch (error) {
          console.error("Initialization failed:", error);
          showStatus("‚ùå Failed to initialize Zoom SDK", "error");
        }
      }

      // Event listeners
      window.addEventListener("DOMContentLoaded", () => {
        init();

        document
          .getElementById("sendCustomBtn")
          .addEventListener("click", sendCustomMessage);
        document
          .getElementById("sendContextBtn")
          .addEventListener("click", sendChatContext);

        // Allow Enter key to send message
        document
          .getElementById("messageInput")
          .addEventListener("keydown", (e) => {
            if (e.key === "Enter" && !e.shiftKey) {
              e.preventDefault();
              sendCustomMessage();
            }
          });
      });
    </script>
  </body>
</html>
